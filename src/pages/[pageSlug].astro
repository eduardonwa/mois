---
import type { SanityDocument } from "@sanity/client";
import { loadQuery } from "../../sanity/lib/load-query";
import { pageQuery } from "../lib/queries";
import { isDraftMode } from "../lib/draftMode";

import Layout from "../layouts/Layout.astro";

const serverDraftMode = isDraftMode(Astro.request);
const visualEditingEnabled = import.meta.env.PUBLIC_SANITY_VISUAL_EDITING_ENABLED === "true";

export async function getStaticPaths() {
  const { data: pages } = await loadQuery<SanityDocument[]>({
    query: `*[_type == "page"]`,
  });

  return pages.map(({ slug }) => ({
       params: { pageSlug: slug.current },
  }));
}

const {pageSlug} = Astro.params;

const { data: page } = await loadQuery({
  query: pageQuery,
  params: { slug: pageSlug },
  perspective: serverDraftMode ? "previewDrafts" : "published",
  visualEditingEnabled
});

// si no hay post y no estamos viendo un borrador
if (!page && !serverDraftMode) {
  return Astro.redirect('/api/draft-mode/disable');
}

//console.log("datos de pagina", page);

// si la p√°gina no existe, redirigir a un 404
if (!page) {
  return Astro.redirect('/404');
}
---

<Layout>
  <h1>{page.heading}</h1>
  <p>{page.subheading}</p>
</Layout>