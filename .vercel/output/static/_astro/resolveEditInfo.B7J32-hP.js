import{o as be,c as ke,C as H,aA as we,X as J,ap as ce,Q as de,$ as R,Y as I,Z as k,an as S,al as ue,a0 as G,a1 as Te,q as Ee,x as z,u as F,t as pe,z as Y,a2 as ve,aB as W,a3 as B,E as Ie,a5 as Se}from"./index.CQkWGOce.js";function qe(e,s){return s===void 0&&(s=null),s=s??e,be(function(n,t){var a=[],r=0;n.subscribe(ke(t,function(o){var i,h,f,m,u=null;r++%s===0&&a.push([]);try{for(var g=H(a),l=g.next();!l.done;l=g.next()){var c=l.value;c.push(o),e<=c.length&&(u=u??[],u.push(c))}}catch(p){i={error:p}}finally{try{l&&!l.done&&(h=g.return)&&h.call(g)}finally{if(i)throw i.error}}if(u)try{for(var y=H(u),d=y.next();!d.done;d=y.next()){var c=d.value;we(a,c),t.next(c)}}catch(p){f={error:p}}finally{try{d&&!d.done&&(m=y.return)&&m.call(y)}finally{if(f)throw f.error}}},function(){var o,i;try{for(var h=H(a),f=h.next();!f.done;f=h.next()){var m=f.value;t.next(m)}}catch(u){o={error:u}}finally{try{f&&!f.done&&(i=h.return)&&i.call(h)}finally{if(o)throw o.error}}t.complete()},void 0,function(){a=null}))})}const w=[];for(let e=0;e<256;++e)w.push((e+256).toString(16).slice(1));function Ae(e,s=0){return(w[e[s+0]]+w[e[s+1]]+w[e[s+2]]+w[e[s+3]]+"-"+w[e[s+4]]+w[e[s+5]]+"-"+w[e[s+6]]+w[e[s+7]]+"-"+w[e[s+8]]+w[e[s+9]]+"-"+w[e[s+10]]+w[e[s+11]]+w[e[s+12]]+w[e[s+13]]+w[e[s+14]]+w[e[s+15]]).toLowerCase()}let K;const $e=new Uint8Array(16);function Re(){if(!K){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");K=crypto.getRandomValues.bind(crypto)}return K($e)}const Me=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),ae={randomUUID:Me};function M(e,s,n){if(ae.randomUUID&&!e)return ae.randomUUID();e=e||{};const t=e.random??e.rng?.()??Re();if(t.length<16)throw new Error("Random bytes length must be >= 16");return t[6]=t[6]&15|64,t[8]=t[8]&63|128,Ae(t)}const v=e=>({context:s})=>{const{count:n,include:t,exclude:a,responseType:r="message.received"}=e;return{count:n,domain:s.domain,from:s.connectTo,include:t?Array.isArray(t)?t:[t]:[],exclude:a?Array.isArray(a)?a:[a]:[],responseType:r,target:s.target,to:s.name}},_e=e=>s=>{const{data:n}=s;return(e.include.length?e.include.includes(n.type):!0)&&(e.exclude.length?!e.exclude.includes(n.type):!0)&&n.domain===e.domain&&n.from===e.from&&n.to===e.to&&(!e.target||s.source===e.target)},Oe=e=>s=>({type:e,message:s}),Pe=Ee(()=>B(window,"message")),X=e=>ce(({input:s})=>Pe.pipe(e?z(e):F(),pe(_e(s)),z(Oe(s.responseType)),s.count?F(qe(s.count),ve(n=>n),Y(s.count)):F())),U="sanity/comlink",xe=3e3,Ce=1e4,Ne=500,q="comlink/response",$="comlink/heartbeat",A="comlink/disconnect",_="comlink/handshake/syn",j="comlink/handshake/syn-ack",O="comlink/handshake/ack",Ue=e=>s=>s.pipe(Y(1),z(()=>{throw new Error(e)})),Q=()=>J({actors:{listen:ce(({input:e})=>{const s=e.signal?B(e.signal,"abort").pipe(Ue(`Request ${e.requestId} aborted`)):Ie,n=t=>t.data?.type===q&&t.data?.responseTo===e.requestId&&!!t.source&&e.sources.has(t.source);return B(window,"message").pipe(pe(n),Y(e.sources.size),Se(s))})},actions:{"send message":({context:e},s)=>{const{sources:n,targetOrigin:t}=e,{message:a}=s;n.forEach(r=>{r.postMessage(a,{targetOrigin:t})})},"on success":W(({context:e})=>e.parentRef,({context:e,self:s})=>(e.response&&e.resolvable?.resolve(e.response),{type:"request.success",requestId:s.id,response:e.response,responseTo:e.responseTo})),"on fail":W(({context:e})=>e.parentRef,({context:e,self:s})=>(e.suppressWarnings||console.warn(`[@sanity/comlink] Received no response to message '${e.type}' on client '${e.from}' (ID: '${e.id}').`),e.resolvable?.reject(new Error("No response received")),{type:"request.failed",requestId:s.id})),"on abort":W(({context:e})=>e.parentRef,({context:e,self:s})=>(e.resolvable?.reject(new Error("Request aborted")),{type:"request.aborted",requestId:s.id}))},guards:{expectsResponse:({context:e})=>e.expectResponse},delays:{initialTimeout:0,responseTimeout:({context:e})=>e.responseTimeout??xe}}).createMachine({context:({input:e})=>({channelId:e.channelId,data:e.data,domain:e.domain,expectResponse:e.expectResponse??!1,from:e.from,id:`msg-${M()}`,parentRef:e.parentRef,resolvable:e.resolvable,response:null,responseTimeout:e.responseTimeout,responseTo:e.responseTo,signal:e.signal,sources:e.sources instanceof Set?e.sources:new Set([e.sources]),suppressWarnings:e.suppressWarnings,targetOrigin:e.targetOrigin,to:e.to,type:e.type}),initial:"idle",on:{abort:".aborted"},states:{idle:{after:{initialTimeout:[{target:"sending"}]}},sending:{entry:{type:"send message",params:({context:e})=>{const{channelId:s,data:n,domain:t,from:a,id:r,responseTo:o,to:i,type:h}=e;return{message:{channelId:s,data:n,domain:t,from:a,id:r,to:i,type:h,responseTo:o}}}},always:[{guard:"expectsResponse",target:"awaiting"},"success"]},awaiting:{invoke:{id:"listen for response",src:"listen",input:({context:e})=>({requestId:e.id,sources:e.sources,signal:e.signal}),onError:"aborted"},after:{responseTimeout:"failed"},on:{message:{actions:R({response:({event:e})=>e.data.data,responseTo:({event:e})=>e.data.responseTo}),target:"success"}}},failed:{type:"final",entry:"on fail"},success:{type:"final",entry:"on success"},aborted:{type:"final",entry:"on abort"}},output:({context:e,self:s})=>({requestId:s.id,response:e.response,responseTo:e.responseTo})}),je=Te(({sendBack:e,input:s})=>{const n=()=>{e(s.event)};s.immediate&&n();const t=setInterval(n,s.interval);return()=>{clearInterval(t)}}),le=()=>J({actors:{requestMachine:Q(),listen:X(),sendBackAtInterval:je},actions:{"buffer message":I(({enqueue:e})=>{e.assign({buffer:({event:s,context:n})=>(k(s,"post"),[...n.buffer,s.data])}),e.emit(({event:s})=>(k(s,"post"),{type:"buffer.added",message:s.data}))}),"create request":R({requests:({context:e,event:s,self:n,spawn:t})=>{k(s,"request");const a=(Array.isArray(s.data)?s.data:[s.data]).map(r=>{const o=`req-${M()}`;return t("requestMachine",{id:o,input:{channelId:e.channelId,data:r.data,domain:e.domain,expectResponse:r.expectResponse,from:e.name,parentRef:n,responseTo:r.responseTo,sources:e.target,targetOrigin:e.targetOrigin,to:e.connectTo,type:r.type}})});return[...e.requests,...a]}}),"emit received message":I(({enqueue:e})=>{e.emit(({event:s})=>(k(s,"message.received"),{type:"message",message:s.message.data}))}),"emit status":G((e,s)=>({type:"status",status:s.status})),"post message":S(({event:e})=>(k(e,"post"),{type:"request",data:{data:e.data.data,expectResponse:!0,type:e.data.type}})),"remove request":I(({context:e,enqueue:s,event:n})=>{k(n,["request.success","request.failed","request.aborted"]),ue(n.requestId),s.assign({requests:e.requests.filter(({id:t})=>t!==n.requestId)})}),respond:S(({event:e})=>(k(e,"response"),{type:"request",data:{data:e.data,type:q,responseTo:e.respondTo}})),"send handshake ack":S({type:"request",data:{type:O}}),"send disconnect":S(()=>({type:"request",data:{type:A}})),"send handshake syn":S({type:"request",data:{type:_}}),"send pending messages":I(({enqueue:e})=>{e.raise(({context:s})=>({type:"request",data:s.buffer.map(({data:n,type:t})=>({data:n,type:t}))})),e.emit(({context:s})=>({type:"buffer.flushed",messages:s.buffer})),e.assign({buffer:[]})}),"set target":R({target:({event:e})=>(k(e,"target.set"),e.target)})},guards:{"has target":({context:e})=>!!e.target,"should send heartbeats":({context:e})=>e.heartbeat}}).createMachine({id:"connection",context:({input:e})=>({id:e.id||`${e.name}-${M()}`,buffer:[],channelId:`chn-${M()}`,connectTo:e.connectTo,domain:e.domain??U,heartbeat:e.heartbeat??!1,name:e.name,requests:[],target:e.target,targetOrigin:e.targetOrigin}),on:{"target.set":{actions:"set target"},"request.success":{actions:"remove request"},"request.failed":{actions:"remove request"}},initial:"idle",states:{idle:{entry:[{type:"emit status",params:{status:"idle"}}],on:{connect:{target:"handshaking",guard:"has target"},post:{actions:"buffer message"}}},handshaking:{id:"handshaking",entry:[{type:"emit status",params:{status:"handshaking"}}],invoke:[{id:"send syn",src:"sendBackAtInterval",input:()=>({event:{type:"syn"},interval:Ne,immediate:!0})},{id:"listen for handshake",src:"listen",input:e=>v({include:j,count:1})(e)}],on:{syn:{actions:"send handshake syn"},request:{actions:"create request"},post:{actions:"buffer message"},"message.received":{target:"connected"},disconnect:{target:"disconnected"}},exit:"send handshake ack"},connected:{entry:["send pending messages",{type:"emit status",params:{status:"connected"}}],invoke:{id:"listen for messages",src:"listen",input:v({exclude:[q,$]})},on:{post:{actions:"post message"},request:{actions:"create request"},response:{actions:"respond"},"message.received":{actions:"emit received message"},disconnect:{target:"disconnected"}},initial:"heartbeat",states:{heartbeat:{initial:"checking",states:{checking:{always:{guard:"should send heartbeats",target:"sending"}},sending:{on:{"request.failed":{target:"#handshaking"}},invoke:{id:"send heartbeat",src:"sendBackAtInterval",input:()=>({event:{type:"post",data:{type:$,data:void 0}},interval:2e3,immediate:!1})}}}}}},disconnected:{id:"disconnected",entry:["send disconnect",{type:"emit status",params:{status:"disconnected"}}],on:{request:{actions:"create request"},post:{actions:"buffer message"},connect:{target:"handshaking",guard:"has target"}}}}}),L=(e,s=le())=>{const n=e.id||`${e.name}-${M()}`,t=de(s,{input:{...e,id:n}}),a=new Map,r=new Map,o=(c,y,d)=>{const p=a.get(c)||new Set;a.has(c)||a.set(c,p),p.add(y);const b=r.get(c);if(b){const T=d?.replay??1;Array.from(b).slice(-T).forEach(async({data:E,id:me})=>{const ne=await y(E);ne&&t.send({type:"response",respondTo:me,data:ne})}),r.delete(c)}return()=>{p.delete(y)}},i=()=>{t.send({type:"connect"})},h=()=>{t.send({type:"disconnect"})},f=(c,y)=>{const{unsubscribe:d}=t.on("status",p=>{y&&p.status!==y||c(p.status)});return d},m=c=>{t.send({type:"target.set",target:c})},u=(c,y)=>{const d={type:c,data:y};t.send({type:"post",data:d})};t.on("message",async({message:c})=>{const y=a.get(c.type);if(y){y.forEach(async p=>{const b=await p(c.data);b&&t.send({type:"response",respondTo:c.id,data:b})});return}const d=r.get(c.type);d?d.add(c):r.set(c.type,new Set([c]))});const g=()=>{t.stop()},l=()=>(t.start(),g);return{actor:t,connect:i,disconnect:h,id:n,name:e.name,machine:s,on:o,onStatus:f,post:u,setTarget:m,start:l,stop:g,get target(){return t.getSnapshot().context.target}}},V=e=>{e.disconnect(),setTimeout(()=>{e.stop()},0)},De=()=>{},cs=e=>{const{targetOrigin:s}=e,n=new Set,t=new Set;return{addTarget:a=>{if(n.has(a))return De;if(!n.size||!t.size)return n.add(a),t.forEach(o=>{o.connections.forEach(i=>{i.setTarget(a),i.connect()})}),()=>{n.delete(a),t.forEach(o=>{o.connections.forEach(i=>{i.target===a&&i.disconnect()})})};n.add(a);const r=new Set;return t.forEach(o=>{const i=L({...o.input,target:a,targetOrigin:s},o.machine);r.add(i),o.connections.add(i),o.subscribers.forEach(({type:h,handler:f,unsubscribers:m})=>{m.push(i.on(h,f))}),o.internalEventSubscribers.forEach(({type:h,handler:f,unsubscribers:m})=>{m.push(i.actor.on(h,f).unsubscribe)}),o.statusSubscribers.forEach(({handler:h,unsubscribers:f})=>{f.push(i.onStatus(m=>h({connection:i.id,status:m})))}),i.start(),i.connect()}),()=>{n.delete(a),r.forEach(o=>{V(o),t.forEach(i=>{i.connections.delete(o)})})}},createChannel:(a,r=le())=>{const o={connections:new Set,input:a,internalEventSubscribers:new Set,machine:r,statusSubscribers:new Set,subscribers:new Set};t.add(o);const{connections:i,internalEventSubscribers:h,statusSubscribers:f,subscribers:m}=o;if(n.size)n.forEach(d=>{const p=L({...a,target:d,targetOrigin:s},r);i.add(p)});else{const d=L({...a,targetOrigin:s},r);i.add(d)}const u=(...d)=>{const[p,b]=d;i.forEach(T=>{T.post(p,b)})},g=(d,p)=>{const b=[];i.forEach(E=>{b.push(E.on(d,p))});const T={type:d,handler:p,unsubscribers:b};return m.add(T),()=>{b.forEach(E=>E()),m.delete(T)}},l=(d,p)=>{const b=[];i.forEach(E=>{b.push(E.actor.on(d,p).unsubscribe)});const T={type:d,handler:p,unsubscribers:b};return h.add(T),()=>{b.forEach(E=>E()),h.delete(T)}},c=d=>{const p=[];i.forEach(T=>{p.push(T.onStatus(E=>d({connection:T.id,status:E})))});const b={handler:d,unsubscribers:p};return f.add(b),()=>{p.forEach(T=>T()),f.delete(b)}},y=()=>{const d=o.connections;d.forEach(V),d.clear(),t.delete(o)};return{on:g,onInternalEvent:l,onStatus:c,post:u,start:()=>(i.forEach(d=>{d.start(),d.connect()}),y),stop:y}},destroy:()=>{t.forEach(({connections:a})=>{a.forEach(V),a.clear()}),t.clear(),n.clear()}}},He=()=>J({actors:{requestMachine:Q(),listen:X()},actions:{"buffer handshake":R({handshakeBuffer:({event:e,context:s})=>(k(e,"message.received"),[...s.handshakeBuffer,e])}),"buffer message":I(({enqueue:e})=>{e.assign({buffer:({event:s,context:n})=>(k(s,"post"),[...n.buffer,{data:s.data,resolvable:s.resolvable,options:s.options}])}),e.emit(({event:s})=>(k(s,"post"),{type:"buffer.added",message:s.data}))}),"create request":R({requests:({context:e,event:s,self:n,spawn:t})=>{k(s,"request");const a=(Array.isArray(s.data)?s.data:[s.data]).map(r=>{const o=`req-${M()}`;return t("requestMachine",{id:o,input:{channelId:e.channelId,data:r.data,domain:e.domain,expectResponse:r.expectResponse,from:e.name,parentRef:n,resolvable:r.resolvable,responseTimeout:r.options?.responseTimeout,responseTo:r.responseTo,signal:r.options?.signal,sources:e.target,suppressWarnings:r.options?.suppressWarnings,targetOrigin:e.targetOrigin,to:e.connectTo,type:r.type}})});return[...e.requests,...a]}}),"emit heartbeat":G(()=>({type:"heartbeat"})),"emit received message":I(({enqueue:e})=>{e.emit(({event:s})=>(k(s,"message.received"),{type:"message",message:s.message.data}))}),"emit status":G((e,s)=>({type:"status",status:s.status})),"post message":S(({event:e})=>(k(e,"post"),{type:"request",data:{data:e.data.data,expectResponse:!!e.resolvable,type:e.data.type,resolvable:e.resolvable,options:e.options}})),"process pending handshakes":I(({context:e,enqueue:s})=>{e.handshakeBuffer.forEach(n=>s.raise(n)),s.assign({handshakeBuffer:[]})}),"remove request":I(({context:e,enqueue:s,event:n})=>{k(n,["request.success","request.failed","request.aborted"]),ue(n.requestId),s.assign({requests:e.requests.filter(({id:t})=>t!==n.requestId)})}),"send response":S(({event:e})=>(k(e,["message.received","heartbeat.received"]),{type:"request",data:{type:q,responseTo:e.message.data.id,data:void 0}})),"send handshake syn ack":S({type:"request",data:{type:j}}),"send pending messages":I(({enqueue:e})=>{e.raise(({context:s})=>({type:"request",data:s.buffer.map(({data:n,resolvable:t,options:a})=>({data:n.data,type:n.type,expectResponse:!!t,resolvable:t,options:a}))})),e.emit(({context:s})=>({type:"buffer.flushed",messages:s.buffer.map(({data:n})=>n)})),e.assign({buffer:[]})}),"set connection config":R({channelId:({event:e})=>(k(e,"handshake.syn"),e.message.data.channelId),target:({event:e})=>(k(e,"handshake.syn"),e.message.source||void 0),targetOrigin:({event:e})=>(k(e,"handshake.syn"),e.message.origin)})},guards:{hasSource:({context:e})=>e.target!==null}}).createMachine({id:"node",context:({input:e})=>({buffer:[],channelId:null,connectTo:e.connectTo,domain:e.domain??U,handshakeBuffer:[],name:e.name,requests:[],target:void 0,targetOrigin:null}),invoke:{id:"listen for handshake syn",src:"listen",input:v({include:_,responseType:"handshake.syn"})},on:{"request.success":{actions:"remove request"},"request.failed":{actions:"remove request"},"request.aborted":{actions:"remove request"},"handshake.syn":{actions:"set connection config",target:".handshaking"}},initial:"idle",states:{idle:{entry:[{type:"emit status",params:{status:"idle"}}],on:{post:{actions:"buffer message"}}},handshaking:{guard:"hasSource",entry:["send handshake syn ack",{type:"emit status",params:{status:"handshaking"}}],invoke:[{id:"listen for handshake ack",src:"listen",input:v({include:O,count:1,responseType:"handshake.complete"}),onDone:"connected"},{id:"listen for disconnect",src:"listen",input:v({include:A,count:1,responseType:"disconnect"})},{id:"listen for messages",src:"listen",input:v({exclude:[A,_,O,$,q]})}],on:{request:{actions:"create request"},post:{actions:"buffer message"},"message.received":{actions:"buffer handshake"},disconnect:{target:"idle"}}},connected:{entry:["process pending handshakes","send pending messages",{type:"emit status",params:{status:"connected"}}],invoke:[{id:"listen for messages",src:"listen",input:v({exclude:[A,_,O,$,q]})},{id:"listen for heartbeat",src:"listen",input:v({include:$,responseType:"heartbeat.received"})},{id:"listen for disconnect",src:"listen",input:v({include:A,count:1,responseType:"disconnect"})}],on:{request:{actions:"create request"},post:{actions:"post message"},disconnect:{target:"idle"},"message.received":{actions:["send response","emit received message"]},"heartbeat.received":{actions:["send response","emit heartbeat"]}}}}}),ds=(e,s=He())=>{const n=de(s,{input:e}),t=new Map,a=new Map,r=(u,g,l)=>{const c=t.get(u)||new Set;t.has(u)||t.set(u,c),c.add(g);const y=a.get(u);if(y){const d=l?.replay??1;Array.from(y).slice(-d).forEach(({data:p})=>g(p)),a.delete(u)}return()=>{c.delete(g)}};let o;const i=(u,g)=>{const{unsubscribe:l}=n.on("status",c=>{o=c.status,!(g&&c.status!==g)&&u(c.status)});return o&&u(o),l},h=(u,g)=>{const l={type:u,data:g};n.send({type:"post",data:l})},f=(u,g,l)=>{const{responseTimeout:c=Ce,signal:y,suppressWarnings:d}=l||{},p=Promise.withResolvers(),b={type:u,data:g};return n.send({type:"post",data:b,resolvable:p,options:{responseTimeout:c,signal:y,suppressWarnings:d}}),p.promise};n.on("message",({message:u})=>{const g=t.get(u.type);if(g){g.forEach(c=>c(u.data));return}const l=a.get(u.type);l?l.add(u):a.set(u.type,new Set([u]))});const m=()=>{n.stop()};return{actor:n,fetch:f,machine:s,on:r,onStatus:i,post:h,start:()=>(n.start(),m),stop:m}},Fe={"handshake/syn":_,"handshake/syn-ack":j,"handshake/ack":O,"channel/response":q,"channel/heartbeat":$,"channel/disconnect":A,"overlay/focus":"visual-editing/focus","overlay/navigate":"visual-editing/navigate","overlay/toggle":"visual-editing/toggle","presentation/toggleOverlay":"presentation/toggle-overlay"},We={[_]:"handshake/syn",[j]:"handshake/syn-ack",[O]:"handshake/ack",[q]:"channel/response",[$]:"channel/heartbeat",[A]:"channel/disconnect","visual-editing/focus":"overlay/focus","visual-editing/navigate":"overlay/navigate","visual-editing/toggle":"overlay/toggle","presentation/toggle-overlay":"presentation/toggleOverlay"},Ke=e=>{const{data:s}=e;return s&&typeof s=="object"&&"domain"in s&&"type"in s&&"from"in s&&"to"in s&&(s.domain==="sanity/channels"&&(s.domain=U),s.to==="overlays"&&(s.to="visual-editing"),s.from==="overlays"&&(s.from="visual-editing"),s.channelId=s.connectionId,delete s.connectionId,s.type=Fe[s.type]??s.type),e},Le=e=>{const{channelId:s,...n}=e,t={...n,connectionId:s};return t.domain===U&&(t.domain="sanity/channels"),t.to==="visual-editing"&&(t.to="overlays"),t.from==="visual-editing"&&(t.from="overlays"),t.type=We[t.type]??t.type,t.type==="channel/response"&&t.responseTo&&!t.data&&(t.data={responseTo:t.responseTo}),(t.type==="handshake/syn"||t.type==="handshake/syn-ack"||t.type==="handshake/ack")&&(t.data={id:t.connectionId}),t},Ve=({context:e},s)=>{const{sources:n,targetOrigin:t}=e,a=Le(s.message);n.forEach(r=>{r.postMessage(a,{targetOrigin:t})})},us=()=>({listen:X(Ke),requestMachine:Q().provide({actions:{"send message":Ve}})});function ps(){return window.self!==window.top}function ls(){return!!window.opener}const Ge=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Z=/_key\s*==\s*['"](.*)['"]/,ze=/^\d*:\d*$/;function ee(e){return typeof e=="number"||typeof e=="string"&&/^\[\d+\]$/.test(e)}function D(e){return typeof e=="string"?Z.test(e.trim()):typeof e=="object"&&"_key"in e}function he(e){if(typeof e=="string"&&ze.test(e))return!0;if(!Array.isArray(e)||e.length!==2)return!1;const[s,n]=e;return(typeof s=="number"||s==="")&&(typeof n=="number"||n==="")}function Be(e,s,n){const t=typeof s=="string"?ye(s):s;if(!Array.isArray(t))throw new Error("Path must be an array or a string");let a=e;for(let r=0;r<t.length;r++){const o=t[r];if(ee(o)){if(!Array.isArray(a))return n;a=a[o]}if(D(o)){if(!Array.isArray(a))return n;a=a.find(i=>i._key===o._key)}if(typeof o=="string"&&(a=typeof a=="object"&&a!==null?a[o]:void 0),typeof a>"u")return n}return a}function fe(e){if(!Array.isArray(e))throw new Error("Path is not an array");return e.reduce((s,n,t)=>{const a=typeof n;if(a==="number")return`${s}[${n}]`;if(a==="string")return`${s}${t===0?"":"."}${n}`;if(D(n)&&n._key)return`${s}[_key=="${n._key}"]`;if(Array.isArray(n)){const[r,o]=n;return`${s}[${r}:${o}]`}throw new Error(`Unsupported path segment \`${JSON.stringify(n)}\``)},"")}function ye(e){if(typeof e!="string")throw new Error("Path is not a string");const s=e.match(Ge);if(!s)throw new Error("Invalid path string");return s.map(Je)}function Je(e){return ee(e)?Ye(e):D(e)?Xe(e):he(e)?Qe(e):e}function Ye(e){return Number(e.replace(/[^\d]/g,""))}function Xe(e){return{_key:e.match(Z)[1]}}function Qe(e){const[s,n]=e.split(":").map(t=>t===""?t:Number(t));return[s,n]}var hs=Object.freeze({__proto__:null,fromString:ye,get:Be,isIndexSegment:ee,isIndexTuple:he,isKeySegment:D,reKeySegment:Z,toString:fe});const Ze="drafts",es="versions",P=".",N=`${Ze}${P}`,ge=`${es}${P}`;function se(e){return e.startsWith(N)}function C(e){return e.startsWith(ge)}function ss(e){return!se(e)&&!C(e)}function fs(e){if(C(e)){const s=te(e);return N+s}return se(e)?e:N+e}function ys(e,s){if(s==="drafts"||s==="published")throw new Error('Version can not be "published" or "drafts"');return`${ge}${s}${P}${te(e)}`}function ts(e){if(!C(e))return;const[s,n,...t]=e.split(P);return n}function te(e){return C(e)?e.split(P).slice(2).join(P):se(e)?e.slice(N.length):e}const re={"\f":"\\f","\n":"\\n","\r":"\\r","	":"\\t","'":"\\'","\\":"\\\\"},oe={"\\f":"\f","\\n":`
`,"\\r":"\r","\\t":"	","\\'":"'","\\\\":"\\"};function ns(e){return`$${e.map(s=>typeof s=="string"?`['${s.replace(/[\f\n\r\t'\\]/g,n=>re[n])}']`:typeof s=="number"?`[${s}]`:s._key!==""?`[?(@._key=='${s._key.replace(/['\\]/g,n=>re[n])}')]`:`[${s._index}]`).join("")}`}function gs(e){const s=[],n=/\['(.*?)'\]|\[(\d+)\]|\[\?\(@\._key=='(.*?)'\)\]/g;let t;for(;(t=n.exec(e))!==null;){if(t[1]!==void 0){const a=t[1].replace(/\\(\\|f|n|r|t|')/g,r=>oe[r]);s.push(a);continue}if(t[2]!==void 0){s.push(parseInt(t[2],10));continue}if(t[3]!==void 0){const a=t[3].replace(/\\(\\')/g,r=>oe[r]);s.push({_key:a,_index:-1});continue}}return s}function as(e){return e.map(s=>{if(typeof s=="string"||typeof s=="number")return s;if(s._key!=="")return{_key:s._key};if(s._index!==-1)return s._index;throw new Error(`invalid segment:${JSON.stringify(s)}`)})}function rs(e){return e.map(s=>{if(typeof s=="string"||typeof s=="number")return s;if(s._index!==-1)return s._index;throw new Error(`invalid segment:${JSON.stringify(s)}`)})}function ms(e,s){if(!s?.mappings)return;const n=ns(rs(e));if(s.mappings[n]!==void 0)return{mapping:s.mappings[n],matchedPath:n,pathSuffix:""};const t=Object.entries(s.mappings).filter(([i])=>n.startsWith(i)).sort(([i],[h])=>h.length-i.length);if(t.length==0)return;const[a,r]=t[0],o=n.substring(a.length);return{mapping:r,matchedPath:a,pathSuffix:o}}function os(e){return e!==null&&Array.isArray(e)}function ie(e){return typeof e=="object"&&e!==null}function x(e,s,n=[]){if(os(e))return e.map((t,a)=>{if(ie(t)){const r=t._key;if(typeof r=="string")return x(t,s,n.concat({_key:r,_index:a}))}return x(t,s,n.concat(a))});if(ie(e)){if(e._type==="block"||e._type==="span"){const t={...e};return e._type==="block"?t.children=x(e.children,s,n.concat("children")):e._type==="span"&&(t.text=x(e.text,s,n.concat("text"))),t}return Object.fromEntries(Object.entries(e).map(([t,a])=>[t,x(a,s,n.concat(t))]))}return s(e,n)}function bs(e){const{baseUrl:s,workspace:n="default",tool:t="default",id:a,type:r,path:o,projectId:i,dataset:h}=e;if(!s)throw new Error("baseUrl is required");if(!o)throw new Error("path is required");if(!a)throw new Error("id is required");if(s!=="/"&&s.endsWith("/"))throw new Error("baseUrl must not end with a slash");const f=n==="default"?void 0:n,m=t==="default"?void 0:t,u=te(a),g=Array.isArray(o)?fe(as(o)):o,l=new URLSearchParams({baseUrl:s,id:u,type:r,path:g});if(f&&l.set("workspace",f),m&&l.set("tool",m),i&&l.set("projectId",i),h&&l.set("dataset",h),ss(a))l.set("perspective","published");else if(C(a)){const d=ts(a);l.set("perspective",d)}const c=[s==="/"?"":s];f&&c.push(f);const y=["mode=presentation",`id=${u}`,`type=${r}`,`path=${encodeURIComponent(g)}`];return m&&y.push(`tool=${m}`),c.push("intent","edit",`${y.join(";")}?${l}`),c.join("/")}export{te as a,ls as b,ds as c,He as d,us as e,bs as f,fs as g,cs as h,ps as i,le as j,ys as k,Be as l,gs as p,ms as r,hs as s,fe as t,M as v,x as w};
