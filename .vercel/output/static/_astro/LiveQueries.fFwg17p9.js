import{G as $,D as L}from"./index.CQkWGOce.js";import{ao as D,ap as U,bS as R,aj as F,bV as K,b as N}from"./studio-component.5JEdvz6o.js";import{a as B,m as G,u as H,b as J}from"./utils.BIMmukQr.js";import{j as X,e as Y,a as O}from"./resolveEditInfo.B7J32-hP.js";import{i as q}from"./DisplayedDocumentBroadcaster.DYfF5bFa.js";import{a as u}from"./index.EmWCQ-Q3.js";import"./client.B76MnFfN.js";function ue(n){const{liveDocument:e,controller:i,perspective:m,onLoadersConnection:a,onDocumentsOnPage:g}=n,[l,j]=u.useState(),[I,T]=u.useState({}),b=D(),v=U();u.useEffect(()=>{const r=setInterval(()=>T(t=>{if(Object.keys(t).length<1)return t;const d=Date.now();if(!Object.values(t).some(s=>s.heartbeat!==!1&&d>s.receivedAt+s.heartbeat))return t;const c={};for(const[s,y]of Object.entries(t))y.heartbeat!==!1&&d>y.receivedAt+y.heartbeat||(c[s]=y);return c}),R);return()=>clearInterval(r)},[]),u.useEffect(()=>{if(i){const r=i.createChannel({name:"presentation",connectTo:"loaders",heartbeat:!0},X().provide({actors:Y()}));return j(r),r.onStatus(a),r.on("loader/documents",t=>{t.projectId===b&&t.dataset===v&&g("loaders",t.perspective,t.documents)}),r.on("loader/query-listen",t=>{if(t.projectId===b&&t.dataset===v){if(typeof t.heartbeat=="number"&&t.heartbeat<R)throw new Error(`Loader query listen heartbeat interval must be at least ${R}ms`);T(d=>({...d,[ee(t.query,t.params)]:{perspective:t.perspective,query:t.query,params:t.params,receivedAt:Date.now(),heartbeat:t.heartbeat??!1}}))}}),r.start()}},[i,v,g,a,b]);const[S]=u.useState(()=>new Set),[C,o]=u.useState(null),p=F({apiVersion:"2023-10-16"}),f=u.useMemo(()=>p.config(),[p]),h=u.useMemo(()=>p.withConfig({resultSourceMap:"withKeyArraySelector"}),[p]);u.useEffect(()=>{if(l){const{projectId:r,dataset:t}=f;l.post("loader/perspective",{projectId:r,dataset:t,perspective:m})}},[l,f,m]);const E=$(r=>{const t=Array.from(S).flat();r.tags.some(d=>t.includes(d))?o(r.id):console.log("No matching tags found",r.tags,{flattenedSyncTags:t})});u.useEffect(()=>{const r=K(h.config()).withConfig({apiVersion:"vX"}).live.events({includeDrafts:!0,tag:"presentation-loader"}).subscribe({next:t=>{t.type==="message"?E(t):t.type==="restart"?o(t.id):t.type==="reconnect"&&o(null)},error:t=>console.error("Error validating EventSource URL:",t)});return()=>r.unsubscribe()},[h,E]);const M=u.useDeferredValue(e);return L.jsx(L.Fragment,{children:Object.entries(I).map(([r,{query:t,params:d,perspective:c}])=>L.jsx(Q,{projectId:f.projectId,dataset:f.dataset,perspective:c,query:t,params:d,comlink:l,client:h,liveDocument:M,lastLiveEventId:C,syncTagsInUse:S},`${r}${c}`))})}function z(n){const e=N.c(14),{projectId:i,dataset:m,perspective:a,query:g,client:l,liveDocument:j,comlink:I,lastLiveEventId:T,syncTagsInUse:b}=n,v=H(n.params),{result:S,resultSourceMap:C,syncTags:o}=W({client:l,liveDocument:j,params:v,perspective:a,query:g,lastLiveEventId:T})||{};let p;e[0]!==m||e[1]!==i?(p=(M,r,t,d,c,s,y)=>{M?.post("loader/query-change",{projectId:i,dataset:m,perspective:r,query:t,params:d,result:c,resultSourceMap:s,tags:y})},e[0]=m,e[1]=i,e[2]=p):p=e[2];const f=$(p);let h,E;return e[3]!==I||e[4]!==f||e[5]!==v||e[6]!==a||e[7]!==g||e[8]!==S||e[9]!==C||e[10]!==b||e[11]!==o?(h=()=>{if(C&&f(I,a,g,v,S,C,o),Array.isArray(o))return b.add(o),()=>{b.delete(o)}},E=[I,f,v,a,g,S,C,b,o],e[3]=I,e[4]=f,e[5]=v,e[6]=a,e[7]=g,e[8]=S,e[9]=C,e[10]=b,e[11]=o,e[12]=h,e[13]=E):(h=e[12],E=e[13]),u.useEffect(h,E),null}const Q=u.memo(z);Q.displayName="Memo(QuerySubscription)";function W(n){const e=N.c(25),{liveDocument:i,client:m,query:a,params:g,perspective:l,lastLiveEventId:j}=n,[I,T]=u.useState(null),[b,v]=u.useState(null);if(b)throw b;let S;e[0]===Symbol.for("react.memo_cache_sentinel")?(S={refreshInterval:0},e[0]=S):S=e[0];const[C,o]=J(S),p=C==="refresh"||C==="inflight"||j!==I?.lastLiveEventId;let f,h;e[1]!==m||e[2]!==j||e[3]!==g||e[4]!==l||e[5]!==a||e[6]!==p||e[7]!==o?(f=()=>{if(!p)return;let c;c=!1;let s;s=!1;const y=new AbortController,V=async function(){const{signal:A}=y;s=!0;const{result:x,resultSourceMap:_,syncTags:k}=await m.fetch(a,g,{lastLiveEventId:j,tag:"presentation-loader",signal:A,perspective:l,filterResponse:!1,returnQuery:!1});s=!1,A.aborted||(T(w=>({result:q(w?.result,x)?w?.result:x,resultSourceMap:q(w?.resultSourceMap,_)?w?.resultSourceMap:_,syncTags:q(w?.syncTags,k)?w?.syncTags:k,lastLiveEventId:j})),c=!0)},P=o();return V().catch(A=>{s=!1,A.name!=="AbortError"&&v(A)}).finally(P),()=>{!c&&!s&&y.abort()}},h=[m,j,g,l,a,p,o],e[1]=m,e[2]=j,e[3]=g,e[4]=l,e[5]=a,e[6]=p,e[7]=o,e[8]=f,e[9]=h):(f=e[8],h=e[9]),u.useEffect(f,h);let E;e[10]!==I?(E=I??{},e[10]=I,e[11]=E):E=e[11];const{result:M,resultSourceMap:r,syncTags:t}=E;let d;e:{if(i&&r){let s;e[12]!==i||e[13]!==l||e[14]!==r||e[15]!==M?(s=Z(i,M,l,r),e[12]=i,e[13]=l,e[14]=r,e[15]=M,e[16]=s):s=e[16];let y;e[17]!==r||e[18]!==t||e[19]!==s?(y={result:s,resultSourceMap:r,syncTags:t},e[17]=r,e[18]=t,e[19]=s,e[20]=y):y=e[20],d=y;break e}let c;e[21]!==r||e[22]!==M||e[23]!==t?(c={result:M,resultSourceMap:r,syncTags:t},e[21]=r,e[22]=M,e[23]=t,e[24]=c):c=e[24],d=c}return d}function Z(n,e,i,m){if(i==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return B(e,m,a=>!a._projectId&&n?._id&&O(n._id)===O(a._id)?typeof n._id=="string"&&typeof a._type=="string"?n:{...n,_id:n._id||a._id,_type:n._type||a._type}:null,G,i)}function ee(n,e){return`${n}-${typeof e=="string"?e:JSON.stringify(e)}`}export{ue as default,Z as turboChargeResultIfSourceMap};
