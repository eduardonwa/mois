import{D as _,ad as H}from"./index.CQkWGOce.js";import{ao as Q,ap as J,bS as z,bT as Z,aj as ee,bU as te,b as re}from"./studio-component.5JEdvz6o.js";import{a as ie,u as ne,b as se,m as ae}from"./utils.BIMmukQr.js";import{j as oe,e as ue,a as q}from"./resolveEditInfo.B7J32-hP.js";import{g as he,a as p}from"./index.EmWCQ-Q3.js";import"./client.B76MnFfN.js";var M,k;function fe(){if(k)return M;k=1;function u(n){if(typeof n!="function")throw new Error("obliterator/iterator: expecting a function!");this.next=n}return typeof Symbol<"u"&&(u.prototype[Symbol.iterator]=function(){return this}),u.of=function(){var n=arguments,c=n.length,f=0;return new u(function(){return f>=c?{done:!0}:{done:!1,value:n[f++]}})},u.empty=function(){var n=new u(function(){return{done:!0}});return n},u.fromSequence=function(n){var c=0,f=n.length;return new u(function(){return c>=f?{done:!0}:{done:!1,value:n[c++]}})},u.is=function(n){return n instanceof u?!0:typeof n=="object"&&n!==null&&typeof n.next=="function"},M=u,M}var P={},B;function ce(){return B||(B=1,P.ARRAY_BUFFER_SUPPORT=typeof ArrayBuffer<"u",P.SYMBOL_SUPPORT=typeof Symbol<"u"),P}var U,D;function x(){if(D)return U;D=1;var u=ce(),n=u.ARRAY_BUFFER_SUPPORT,c=u.SYMBOL_SUPPORT;return U=function(a,s){var r,t,e,i,o;if(!a)throw new Error("obliterator/forEach: invalid iterable.");if(typeof s!="function")throw new Error("obliterator/forEach: expecting a callback.");if(Array.isArray(a)||n&&ArrayBuffer.isView(a)||typeof a=="string"||a.toString()==="[object Arguments]"){for(e=0,i=a.length;e<i;e++)s(a[e],e);return}if(typeof a.forEach=="function"){a.forEach(s);return}if(c&&Symbol.iterator in a&&typeof a.next!="function"&&(a=a[Symbol.iterator]()),typeof a.next=="function"){for(r=a,e=0;o=r.next(),o.done!==!0;)s(o.value,e),e++;return}for(t in a)a.hasOwnProperty(t)&&s(a[t],t)},U}var L={},F;function V(){return F||(F=1,function(u){var n=Math.pow(2,8)-1,c=Math.pow(2,16)-1,f=Math.pow(2,32)-1,a=Math.pow(2,7)-1,s=Math.pow(2,15)-1,r=Math.pow(2,31)-1;u.getPointerArray=function(e){var i=e-1;if(i<=n)return Uint8Array;if(i<=c)return Uint16Array;if(i<=f)return Uint32Array;throw new Error("mnemonist: Pointer Array of size > 4294967295 is not supported.")},u.getSignedPointerArray=function(e){var i=e-1;return i<=a?Int8Array:i<=s?Int16Array:i<=r?Int32Array:Float64Array},u.getNumberType=function(e){return e===(e|0)?Math.sign(e)===-1?e<=127&&e>=-128?Int8Array:e<=32767&&e>=-32768?Int16Array:Int32Array:e<=255?Uint8Array:e<=65535?Uint16Array:Uint32Array:Float64Array};var t={Uint8Array:1,Int8Array:2,Uint16Array:3,Int16Array:4,Uint32Array:5,Int32Array:6,Float32Array:7,Float64Array:8};u.getMinimalRepresentation=function(e,i){var o=null,h=0,d,m,g,y,w;for(y=0,w=e.length;y<w;y++)g=i?i(e[y]):e[y],m=u.getNumberType(g),d=t[m.name],d>h&&(h=d,o=m);return o},u.isTypedArray=function(e){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView(e)},u.concat=function(){var e=0,i,o,h;for(i=0,h=arguments.length;i<h;i++)e+=arguments[i].length;var d=new arguments[0].constructor(e);for(i=0,o=0;i<h;i++)d.set(arguments[i],o),o+=arguments[i].length;return d},u.indices=function(e){for(var i=u.getPointerArray(e),o=new i(e),h=0;h<e;h++)o[h]=h;return o}}(L)),L}var C={},N;function W(){if(N)return C;N=1;var u=x(),n=V();function c(r){return Array.isArray(r)||n.isTypedArray(r)}function f(r){if(typeof r.length=="number")return r.length;if(typeof r.size=="number")return r.size}function a(r){var t=f(r),e=typeof t=="number"?new Array(t):[],i=0;return u(r,function(o){e[i++]=o}),e}function s(r){var t=f(r),e=typeof t=="number"?n.getPointerArray(t):Array,i=typeof t=="number"?new Array(t):[],o=typeof t=="number"?new e(t):[],h=0;return u(r,function(d){i[h]=d,o[h]=h++}),[i,o]}return C.isArrayLike=c,C.guessLength=f,C.toArray=a,C.toArrayWithIndices=s,C}var j,G;function le(){if(G)return j;G=1;var u=fe(),n=x(),c=V(),f=W();function a(s,r,t){if(arguments.length<2&&(t=s,s=null,r=null),this.capacity=t,typeof this.capacity!="number"||this.capacity<=0)throw new Error("mnemonist/lru-cache: capacity should be positive number.");if(!isFinite(this.capacity)||Math.floor(this.capacity)!==this.capacity)throw new Error("mnemonist/lru-cache: capacity should be a finite positive integer.");var e=c.getPointerArray(t);this.forward=new e(t),this.backward=new e(t),this.K=typeof s=="function"?new s(t):new Array(t),this.V=typeof r=="function"?new r(t):new Array(t),this.size=0,this.head=0,this.tail=0,this.items={}}return a.prototype.clear=function(){this.size=0,this.head=0,this.tail=0,this.items={}},a.prototype.splayOnTop=function(s){var r=this.head;if(this.head===s)return this;var t=this.backward[s],e=this.forward[s];return this.tail===s?this.tail=t:this.backward[e]=t,this.forward[t]=e,this.backward[r]=s,this.head=s,this.forward[s]=r,this},a.prototype.set=function(s,r){var t=this.items[s];if(typeof t<"u"){this.splayOnTop(t),this.V[t]=r;return}this.size<this.capacity?t=this.size++:(t=this.tail,this.tail=this.backward[t],delete this.items[this.K[t]]),this.items[s]=t,this.K[t]=s,this.V[t]=r,this.forward[t]=this.head,this.backward[this.head]=t,this.head=t},a.prototype.setpop=function(s,r){var t=null,e=null,i=this.items[s];return typeof i<"u"?(this.splayOnTop(i),t=this.V[i],this.V[i]=r,{evicted:!1,key:s,value:t}):(this.size<this.capacity?i=this.size++:(i=this.tail,this.tail=this.backward[i],t=this.V[i],e=this.K[i],delete this.items[e]),this.items[s]=i,this.K[i]=s,this.V[i]=r,this.forward[i]=this.head,this.backward[this.head]=i,this.head=i,e?{evicted:!0,key:e,value:t}:null)},a.prototype.has=function(s){return s in this.items},a.prototype.get=function(s){var r=this.items[s];if(!(typeof r>"u"))return this.splayOnTop(r),this.V[r]},a.prototype.peek=function(s){var r=this.items[s];if(!(typeof r>"u"))return this.V[r]},a.prototype.forEach=function(s,r){r=arguments.length>1?r:this;for(var t=0,e=this.size,i=this.head,o=this.K,h=this.V,d=this.forward;t<e;)s.call(r,h[i],o[i],this),i=d[i],t++},a.prototype.keys=function(){var s=0,r=this.size,t=this.head,e=this.K,i=this.forward;return new u(function(){if(s>=r)return{done:!0};var o=e[t];return s++,s<r&&(t=i[t]),{done:!1,value:o}})},a.prototype.values=function(){var s=0,r=this.size,t=this.head,e=this.V,i=this.forward;return new u(function(){if(s>=r)return{done:!0};var o=e[t];return s++,s<r&&(t=i[t]),{done:!1,value:o}})},a.prototype.entries=function(){var s=0,r=this.size,t=this.head,e=this.K,i=this.V,o=this.forward;return new u(function(){if(s>=r)return{done:!0};var h=e[t],d=i[t];return s++,s<r&&(t=o[t]),{done:!1,value:[h,d]}})},typeof Symbol<"u"&&(a.prototype[Symbol.iterator]=a.prototype.entries),a.prototype.inspect=function(){for(var s=new Map,r=this.entries(),t;t=r.next(),!t.done;)s.set(t.value[0],t.value[1]);return Object.defineProperty(s,"constructor",{value:a,enumerable:!1}),s},typeof Symbol<"u"&&(a.prototype[Symbol.for("nodejs.util.inspect.custom")]=a.prototype.inspect),a.from=function(s,r,t,e){if(arguments.length<2){if(e=f.guessLength(s),typeof e!="number")throw new Error("mnemonist/lru-cache.from: could not guess iterable length. Please provide desired capacity as last argument.")}else arguments.length===2&&(e=r,r=null,t=null);var i=new a(r,t,e);return n(s,function(o,h){i.set(h,o)}),i},j=a,j}var O,Y;function de(){if(Y)return O;Y=1;var u=le(),n=x(),c=V(),f=W();function a(r,t,e){arguments.length<2?u.call(this,r):u.call(this,r,t,e);var i=c.getPointerArray(this.capacity);this.deleted=new i(this.capacity),this.deletedSize=0}for(var s in u.prototype)a.prototype[s]=u.prototype[s];return typeof Symbol<"u"&&(a.prototype[Symbol.iterator]=u.prototype[Symbol.iterator]),a.prototype.clear=function(){u.prototype.clear.call(this),this.deletedSize=0},a.prototype.set=function(r,t){var e=this.items[r];if(typeof e<"u"){this.splayOnTop(e),this.V[e]=t;return}this.size<this.capacity?(this.deletedSize>0?e=this.deleted[--this.deletedSize]:e=this.size,this.size++):(e=this.tail,this.tail=this.backward[e],delete this.items[this.K[e]]),this.items[r]=e,this.K[e]=r,this.V[e]=t,this.forward[e]=this.head,this.backward[this.head]=e,this.head=e},a.prototype.setpop=function(r,t){var e=null,i=null,o=this.items[r];return typeof o<"u"?(this.splayOnTop(o),e=this.V[o],this.V[o]=t,{evicted:!1,key:r,value:e}):(this.size<this.capacity?(this.deletedSize>0?o=this.deleted[--this.deletedSize]:o=this.size,this.size++):(o=this.tail,this.tail=this.backward[o],e=this.V[o],i=this.K[o],delete this.items[i]),this.items[r]=o,this.K[o]=r,this.V[o]=t,this.forward[o]=this.head,this.backward[this.head]=o,this.head=o,i?{evicted:!0,key:i,value:e}:null)},a.prototype.delete=function(r){var t=this.items[r];if(typeof t>"u")return!1;if(delete this.items[r],this.size===1)return this.size=0,this.head=0,this.tail=0,this.deletedSize=0,!0;var e=this.backward[t],i=this.forward[t];return this.head===t&&(this.head=i),this.tail===t&&(this.tail=e),this.forward[e]=i,this.backward[i]=e,this.size--,this.deleted[this.deletedSize++]=t,!0},a.prototype.remove=function(r,t=void 0){var e=this.items[r];if(typeof e>"u")return t;var i=this.V[e];if(delete this.items[r],this.size===1)return this.size=0,this.head=0,this.tail=0,this.deletedSize=0,i;var o=this.backward[e],h=this.forward[e];return this.head===e&&(this.head=h),this.tail===e&&(this.tail=o),this.forward[o]=h,this.backward[h]=o,this.size--,this.deleted[this.deletedSize++]=e,i},a.from=function(r,t,e,i){if(arguments.length<2){if(i=f.guessLength(r),typeof i!="number")throw new Error("mnemonist/lru-cache.from: could not guess iterable length. Please provide desired capacity as last argument.")}else arguments.length===2&&(i=t,t=null,e=null);var o=new a(t,e,i);return n(r,function(h,d){o.set(d,h)}),o},O=a,O}var pe=de();const ye=he(pe);function Te(u){const{liveDocument:n,controller:c,perspective:f,documentsOnPage:a,onLoadersConnection:s,onDocumentsOnPage:r}=u,[t,e]=p.useState(),[i,o]=p.useState({}),h=Q(),d=J();p.useEffect(()=>{const v=setInterval(()=>o(l=>{if(Object.keys(l).length<1)return l;const S=Date.now();if(!Object.values(l).some(R=>R.heartbeat!==!1&&S>R.receivedAt+R.heartbeat))return l;const b={};for(const[R,T]of Object.entries(l))T.heartbeat!==!1&&S>T.receivedAt+T.heartbeat||(b[R]=T);return b}),z);return()=>clearInterval(v)},[]),p.useEffect(()=>{if(c){const v=c.createChannel({name:"presentation",connectTo:"loaders",heartbeat:!0},oe().provide({actors:ue()}));return e(v),v.onStatus(s),v.on("loader/documents",l=>{l.projectId===h&&l.dataset===d&&r("loaders",l.perspective,l.documents)}),v.on("loader/query-listen",l=>{if(l.projectId===h&&l.dataset===d){if(typeof l.heartbeat=="number"&&l.heartbeat<z)throw new Error(`Loader query listen heartbeat interval must be at least ${z}ms`);o(S=>({...S,[Ae(l.query,l.params)]:{perspective:l.perspective,query:l.query,params:l.params,receivedAt:Date.now(),heartbeat:l.heartbeat??!1}}))}}),v.start()}},[c,d,r,s,h]);const[m]=p.useState(()=>new ye(Z)),g=ee({apiVersion:"2023-10-16"}),y=p.useMemo(()=>g.config(),[g]),w=p.useMemo(()=>g.withConfig({resultSourceMap:"withKeyArraySelector"}),[g]);p.useEffect(()=>{if(t){const{projectId:v,dataset:l}=y;t.post("loader/perspective",{projectId:v,dataset:l,perspective:f})}},[t,y,f]);const E=p.useMemo(()=>{const v=a.map(({_id:b})=>b),l=[...new Set(v)],S=m.capacity;return l.length>=S&&(l.length=S),l},[m.capacity,a]),[I,A]=p.useState(0);return _.jsxs(_.Fragment,{children:[_.jsx(me,{cache:m,client:w,turboIds:E,setDocumentsCacheLastUpdated:A}),Object.entries(i).map(([v,{query:l,params:S,perspective:b}])=>_.jsx(ve,{cache:m,projectId:y.projectId,dataset:y.dataset,perspective:b,query:l,params:S,comlink:t,client:w,refreshInterval:f?2e3:0,liveDocument:n,documentsCacheLastUpdated:I},`${v}${b}`))]})}const me=p.memo(function(u){const{cache:n,client:c,turboIds:f,setDocumentsCacheLastUpdated:a}=u,[s,r]=p.useState([]);return p.useEffect(()=>{const t=new Set(s.flat()),e=new Set;for(const h of f)!t.has(h)&&!n.has(h)&&e.add(h);const i=[...e].slice(0,te);if(i.length===0)return;const o=requestAnimationFrame(()=>r(h=>[...h.slice(-100),i]));return()=>cancelAnimationFrame(o)},[s,n,f]),p.useEffect(()=>{const t=c.listen("*",{},{events:["mutation"],effectFormat:"mendoza",includePreviousRevision:!1,includeResult:!1,tag:"presentation-loader"}).subscribe(e=>{if(e.type==="mutation"&&e.transition==="disappear"&&n.delete(e.documentId)&&a(Date.now()),e.type!=="mutation"||!e.effects?.apply?.length)return;const i=n.peek(e.documentId);if(i){const o={...i};delete o._rev;const h=H(o,e.effects.apply);n.set(e.documentId,h),a(Date.now())}});return()=>t.unsubscribe()},[n,c,a]),_.jsx(_.Fragment,{children:s.map(t=>_.jsx(X,{cache:n,client:c,ids:t,setDocumentsCacheLastUpdated:a},JSON.stringify(t)))})}),X=p.memo(function(u){const{client:n,cache:c,ids:f,setDocumentsCacheLastUpdated:a}=u;return p.useEffect(()=>{const s=f.filter(r=>!c.has(r));s.length!==0&&n.getDocuments(s).then(r=>{for(const t of r)t&&t?._id&&(c.set(t._id,t),a(Date.now()))},console.error)},[c,n,f,a]),null});X.displayName="GetDocuments";function ve(u){const n=re.c(20),{cache:c,projectId:f,dataset:a,perspective:s,query:r,client:t,refreshInterval:e,liveDocument:i,comlink:o,documentsCacheLastUpdated:h}=u,d=ne(u.params);let m;n[0]!==c||n[1]!==t||n[2]!==h||n[3]!==i||n[4]!==d||n[5]!==s||n[6]!==r||n[7]!==e?(m={cache:c,client:t,liveDocument:i,params:d,perspective:s,query:r,refreshInterval:e,documentsCacheLastUpdated:h},n[0]=c,n[1]=t,n[2]=h,n[3]=i,n[4]=d,n[5]=s,n[6]=r,n[7]=e,n[8]=m):m=n[8];const g=we(m),y=g?.result,w=g?.resultSourceMap,E=g?.tags;let I,A;return n[9]!==o||n[10]!==a||n[11]!==d||n[12]!==s||n[13]!==f||n[14]!==r||n[15]!==y||n[16]!==w||n[17]!==E?(I=()=>{w&&o?.post("loader/query-change",{projectId:f,dataset:a,perspective:s,query:r,params:d,result:y,resultSourceMap:w,tags:E})},A=[o,a,d,s,f,r,y,w,E],n[9]=o,n[10]=a,n[11]=d,n[12]=s,n[13]=f,n[14]=r,n[15]=y,n[16]=w,n[17]=E,n[18]=I,n[19]=A):(I=n[18],A=n[19]),p.useEffect(I,A),null}function we(u){const{cache:n,liveDocument:c,client:f,refreshInterval:a,query:s,params:r,perspective:t,documentsCacheLastUpdated:e}=u,[i,o]=p.useState(null),{projectId:h,dataset:d}=p.useMemo(()=>{const{projectId:I,dataset:A}=f.config();return{projectId:I,dataset:A}},[f]),[m,g]=p.useState(null);if(m)throw m;const[y,w]=se({refreshInterval:a}),E=y==="refresh"||y==="inflight";return p.useEffect(()=>{if(!E)return;let I=!1,A=!1;const v=new AbortController;async function l(){const{signal:b}=v;A=!0;const{result:R,resultSourceMap:T,syncTags:$}=await f.fetch(s,r,{tag:"presentation-loader",signal:b,perspective:t,filterResponse:!1});A=!1,b.aborted||(o({result:R,resultSourceMap:T,tags:$}),I=!0)}const S=w();return l().catch(b=>{A=!1,b.name!=="AbortError"&&g(b)}).finally(S),()=>{!I&&!A&&v.abort()}},[f,d,c,r,t,h,s,E,w]),p.useMemo(()=>e&&i?.resultSourceMap?{result:ge(n,c,i.result,t,i.resultSourceMap),resultSourceMap:i.resultSourceMap}:i,[n,e,c,t,i])}let K=!1;function ge(u,n,c,f,a){if(f==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return ie(c,a,s=>{if(s._projectId){K||(console.warn("Cross dataset references are not supported yet, ignoring source document",s),K=!0);return}return n?._id&&q(n._id)===q(s._id)?typeof n._id=="string"&&typeof s._type=="string"?n:{...n,_id:n._id||s._id,_type:n._type||s._type}:u.get(s._id)},ae,f)}function Ae(u,n){return`${u}-${typeof n=="string"?n:JSON.stringify(n)}`}export{Te as default,ge as turboChargeResultIfSourceMap};
