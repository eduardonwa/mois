import{b as R,u as O,c0 as q,aj as U,aw as V,c1 as C,c2 as B,c3 as L,c4 as K}from"./studio-component.5JEdvz6o.js";import{a as w}from"./index.EmWCQ-Q3.js";import{D as _}from"./index.CQkWGOce.js";import"./client.B76MnFfN.js";function W(n){const{validation:e}=n.type;if(!e)return!1;const r=Array.isArray(e)?e:[e];for(const f of r){let l=!1;const c=new Proxy({},{get:(y,p)=>()=>(p==="required"&&(l=!0),c)});if(typeof f=="function"&&(f(c),l)||typeof f=="object"&&f!==null&&"_required"in f&&f._required==="required")return!0}return!1}function v(n,e){let r=n;for(;r;){if(r.name===e||r.type&&r.type.name===e)return!0;r=r.type}return!1}function Y(n){return v(n,"object")||n.jsonType==="object"||"fields"in n}function z(n){return v(n,"array")}function x(n){return v(n,"reference")}function G(n){return v(n,"crossDatasetReference")}function H(n){return v(n,"string")}function J(n){return v(n,"number")}function E(n){let e=n;for(;e;){if(!e.type)return e;e=e.type}}function A(n){return"fields"in n?n.type?A(n.type).concat(n.fields):n.fields:[]}function Q(n){const e=new Set;function r(i,u){if(!e.has(i)){if(e.add(i),"fields"in i)for(const a of A(i)){const t=E(a.type);if(t.name==="document"){u.add(t);continue}let o;i.type.type?o=a.type.type.name:"jsonType"in i.type&&(o=a.type.jsonType),(o==="object"||o==="block")&&(x(a.type)?a.type.to.forEach(s=>u.add(s.type)):u.add(a.type)),r(a.type,u)}else if("of"in i)for(const a of i.of)r(a,u)}}const f=new Map;n.getTypeNames().forEach(i=>{const u=n.get(i);if(u===void 0||u.type===null)return;const a=new Set;r(u,a),f.set(u,a),e.clear()});const l=[],c=new Set,y=new Set;function p(i){if(y.has(i)||c.has(i))return;c.add(i);const u=f.get(i);u!==void 0&&u.forEach(a=>p(a)),c.delete(i),y.add(i),l.includes(i.name)||l.unshift(i.name)}for(const[i]of f)p(i);return l}const X=function(n){const e=R.c(6),{schemaType:r,theme:f}=n,{theme:l,scheme:c,tone:y}=f;let p;e[0]===Symbol.for("react.memo_cache_sentinel")?(p=new B,e[0]=p):p=e[0];const i=p,u=r.icon;let a;return e[1]!==u||e[2]!==c||e[3]!==l||e[4]!==y?(a=u?_.jsx(L,{sheet:i.instance,children:_.jsx(K,{theme:l,scheme:c,tone:y,children:w.isValidElement(u)?u:_.jsx(u,{})})}):null,e[1]=u,e[2]=c,e[3]=l,e[4]=y,e[5]=a):a=e[5],a},Z=n=>({_id:{type:"objectField",name:"_id",value:{type:"string"}},_type:{type:"objectField",name:"_type",value:{type:"string",value:n}},_createdAt:{type:"objectField",name:"_createdAt",value:{type:"string"}},_updatedAt:{type:"objectField",name:"_updatedAt",value:{type:"string"}},_rev:{type:"objectField",name:"_rev",value:{type:"string"}}});function T(n){const e=n.options?.list;return e&&Array.isArray(e)?{type:"union",of:e.map(r=>({type:"string",value:typeof r=="string"?r:r.value}))}:{type:"string"}}function ee(n){const e=n.options?.list;return e&&Array.isArray(e)?{type:"union",of:e.map(r=>({type:"number",value:typeof r=="number"?r:r.value}))}:{type:"number"}}function F(n,e=!1){const r={_ref:{type:"objectField",name:"_ref",value:{type:"string"}},_type:{type:"objectField",name:"_type",value:{type:"string",value:"reference"}},_weak:{type:"objectField",name:"_weak",value:{type:"boolean"},optional:!0}};return e&&(r._key={type:"objectField",name:"_key",value:{type:"string"}}),{type:"object",fields:r,dereferencesTo:n}}function te(n){const e=ne(n);return e.length===1?F(e[0]):{type:"union",of:e.map(r=>({type:"unionOption",name:r,value:F(r)}))}}function ne(n){const e=M(n);return[...new Set([...e.map(r=>r.name)])]}function M(n){const e="to"in n?n.to:[];return"type"in n&&x(n.type)?[...M(n.type),...e]:e}const S=new Map([["text",{type:"string"}],["url",{type:"string"}],["datetime",{type:"string"}],["date",{type:"string"}],["boolean",{type:"boolean"}],["email",{type:"string"}]]);function re(n,e){const r=new Set,{schema:f,basePath:l}=n;return Q(f).map(t=>{const o=f.get(t);if(o===void 0)return;const s=y(o);if(s!==null)return s.type==="type"&&r.add(o),s}).filter(t=>t!==void 0);function c(t){if(t.icon)return C.renderToString(_.jsx(X,{schemaType:t,theme:e}))}function y(t){let o;if(t.type?o=t.type.name:"jsonType"in t&&(o=t.jsonType),o==="document"){const g=p(t);return g.type==="unknown"?null:{type:"document",name:t.name,title:typeof t.title=="string"?t.title:void 0,icon:c(t),fields:{...Z(t.name),...g.fields}}}const s=i(t);return s.type==="unknown"?null:s.type==="object"?{name:t.name,type:"type",value:{type:"object",fields:{_type:{type:"objectField",name:"_type",value:{type:"string",value:t.name}},...s.fields}}}:{name:t.name,title:typeof t.title=="string"?t.title:void 0,type:"type",value:s}}function p(t){const o={};for(const s of A(t)){const g=i(s.type);g!==null&&(o[s.name]={type:"objectField",name:s.name,title:typeof s.type.title=="string"?s.type.title:void 0,value:g,optional:W(s)===!1})}return{type:"object",fields:o}}function i(t){if(E(t)?.name==="document")return F(t.name);if(r.has(t.type))return{type:"inline",name:t.type.name};if(t.type?.type?.name==="object")return{type:"inline",name:t.type.name};if(H(t))return T(t);if(J(t))return ee(t);const o=S.get(t.type?.name||"");if(o)return o;if(t.type&&S.has(t.type.name))return S.get(t.type.name);if(G(t))return{type:"unknown"};if(x(t))return te(t);if(z(t))return a(t);if(Y(t))return p(t);throw new Error(`Type "${t.name}" not found`)}function u(t,o){const{options:s}=t;if(!s)return;const g={...s};return s.insertMenu&&(g.insertMenu={...s.insertMenu,views:s.insertMenu.views?.map(b=>b.name==="grid"?{name:"grid",previewImageUrls:b.previewImageUrl?o.reduce((d,{name:m})=>{const j=b.previewImageUrl?.(m);if(!j)return d;try{new URL(j),d[m]=j}catch{d[m]=new URL(j,`${window.location.origin}${l?`${l}/`:""}`).toString()}return d},{}):void 0}:b)}),g}function a(t){const o=[];for(const d of t.of){let m=i(d);const j={type:"unionOption",icon:c(d),name:d.name,title:typeof d.title=="string"?d.title:void 0,value:m};m.type==="inline"?m={type:"object",fields:{_key:h()},rest:m}:m.type==="object"&&(m.rest={type:"object",fields:{_key:h()}}),j.value=m,o.push(j)}if(o.length===0)return{type:"null"};if(o.length>1)return{type:"union",of:o,options:u(t,o)};const{name:s,title:g,value:b}=o[0];return{type:"array",of:{type:"arrayItem",name:s,title:typeof g=="string"?g:void 0,value:b}}}}function h(){return{type:"objectField",name:"_key",value:{type:"string"}}}function ie(n){const e=n.reduce((r,{id:f,path:l})=>(r[f]?r[f].add(l):r[f]=new Set([l]),r),{});return Object.entries(e)}function oe(n){const e=R.c(11),{comlink:r,perspective:f}=n,l=O(),c=q();let y,p;e[0]!==r||e[1]!==c||e[2]!==l?(y=()=>{try{const o=re(l,c);return r.post("presentation/schema",{schema:o}),r.on("visual-editing/schema",()=>({schema:o}))}catch{return}},p=[r,c,l],e[0]=r,e[1]=c,e[2]=l,e[3]=y,e[4]=p):(y=e[3],p=e[4]),w.useEffect(y,p);let i;e[5]===Symbol.for("react.memo_cache_sentinel")?(i={apiVersion:V},e[5]=i):i=e[5];const u=U(i);let a,t;return e[6]!==u||e[7]!==r||e[8]!==f?(a=()=>r.on("visual-editing/schema-union-types",async o=>{const s=ie(o.paths),g=await Promise.all(s.map(async d=>{const[m,j]=d,k=Array.from(j),N=`*[_id == $id][0]{${k.map(se).join(",")}}`,$=await u.fetch(N,{id:m},{perspective:f,tag:"presentation-schema"}),P=k.map((D,I)=>({path:D,type:$[I]}));return{id:m,paths:P}})),b=new Map;return g.forEach(d=>{b.set(d.id,new Map(d.paths.map(ue)))}),{types:b}}),t=[r,u,f],e[6]=u,e[7]=r,e[8]=f,e[9]=a,e[10]=t):(a=e[9],t=e[10]),w.useEffect(a,t),null}function ue(n){const{path:e,type:r}=n;return[e,r]}function se(n,e){return`"${e}": ${n}[0]._type`}var pe=w.memo(oe);export{pe as default};
